//TODO: width is not correct sometimes on the very first run.
YUI.add("ez-form-editor",function(e){"use strict";function p(e){p.superclass.constructor.apply(this,arguments)}e.namespace("eZ");var t=e.Lang,n,r,i,s,o,u,a,f,l,c,h;p.NAME="form-editor",p.CSS_PREFIX="ez-ei-"+p.NAME,p.ATTRS={topNavigationClassName:{value:"-top-navigation"},dialogClassName:{value:"-dialog"},dialogContentClassName:{value:"-dialog-content"},markerClassName:{value:"-marker"},wrapperClassName:{value:"-wrapper"},dialogToolBarId:{value:"-toolbar"},dialogHeaderId:{value:"-header"},dialogHeaderHeight:{value:31}},p.HTML_PARSER={},e.extend(p,e.Widget,{initializer:function(){n=this.get("srcNode"),a=e.Handlebars.compile(e.one("#ezp-nein-form-text-field").getHTML()),f=e.Handlebars.compile(e.one("#ezp-nein-form-image-field").getHTML()),l=e.Handlebars.compile(e.one("#ezp-nein-form-textarea-field").getHTML()),c=e.Handlebars.compile(e.one("#ezp-nein-form-plug-field").getHTML())},destructor:function(){},renderUI:function(){},bindUI:function(){},syncUI:function(){},showFormEditor:function(t){e.one(".ez-ei-header").hide(),e.one(".ez-ei-content-wrapper").hide(),e.one(".ez-ei-linear").hide(),e.one(".ez-ei-working-bench").addClass("form-editor-mode"),t&&(this._getFormEditorTarget()?(this._showFormEditorNodes(),this._syncFormEditorNodes(t)):(this._createFormEditorNodes(t),this._syncFormEditorNodes(t)),this.flagVisible=!0)},syncFormEditor:function(){var e=this._getFormEditorTarget();e&&this.flagVisible&&(this._syncFormEditorNodes(e),console.log("FE sync"))},hideFormEditor:function(){this._hideFormEditorNodes(),this.flagVisible=!1,e.one(".ez-ei-header").show(),e.one(".ez-ei-content-wrapper").show(),e.one(".ez-ei-linear").show(),e.one(".ez-ei-working-bench").removeClass("form-editor-mode")},_getFormEditorTarget:function(){return s?e.one("#"+s.getAttribute("data-ez-form-editor-target-id")):!1},_createFormEditorNodes:function(t){var u=p.CSS_PREFIX,a=u+this.get("topNavigationClassName"),f=u+this.get("dialogContentClassName"),l=u+this.get("wrapperClassName");r=e.Node.create(['<div id="',a,'" class="',u,'"><ul><li><span data-icon="&#x0034;"></span><a href="#return" id="',a,"-return",'">Return to preview</a></li></ul></div>'].join("")),i=e.Node.create(['<div id="',u+this.get("dialogHeaderId"),'" class="',u,'">',"</div>"].join("")),this._createToolBarNode(),s.setAttribute("data-ez-form-editor-target-id",t.getAttribute("id")),o=e.Node.create(['<div class="',f," ",u,'" ></div>'].join("")),s.appendChild(o),n.appendChild(i),n.appendChild(s),n.appendChild(r),this._breadcrumbs=new e.eZ.Breadcrumbs({callerID:p.NAME,srcNode:"#"+i.generateID(),focusedNode:t,linkClickCallback:this._breadcrumbsLinkClickCallback,closeClickCallback:this._breadcrumbsCloseClickCallback}),s.delegate("click",this._publishLinkClick,"."+u+"-button-publish",this),s.delegate("click",this._closeLinkClick,"."+u+"-button-discard"),r.delegate("click",this._topNavigationReturnClick,"#"+u+this.get("topNavigationClassName")+"-return"),o.delegate("click",this._markerClick,"."+u+this.get("markerClassName")),o.delegate("click",this._imageFileSelectClick,".image-file-select-button"),e.fire("formEditor:onCreate")},_createToolBarNode:function(){var t=p.CSS_PREFIX,n=e.one("#ezp-nein-dialog-toolbar").getHTML(),r=e.Handlebars.compile(n);s=e.Node.create(r({cssPrefix:t,dialogToolBarId:this.get("dialogToolBarId"),dialogClassName:t+this.get("dialogClassName"),buttons:[{action:"discard",icon:"&#x0036;"},{action:"publish",icon:"&#xe064;"}]}))},_syncFormEditorNodes:function(e){s.setAttribute("data-ez-form-editor-target-id",e.getAttribute("id")),this._refillDialogContent(),r.setXY([n.getX()-10,n.getY()-47]);var t=parseInt(n.getComputedStyle("width"),10),u=t,a=this.get("dialogHeaderHeight");i.setStyles({width:u-5,height:a-2}),s.setStyles({width:u}),o.setStyles({width:u-12}),this._breadcrumbs.update(e),this._setFocus()},_refillDialogContent:function(){var t=p.CSS_PREFIX,n=t+this.get("markerClassName");o.empty();var r=this._getFormEditorTarget(),i=this,s=!1;if(r.hasAttribute("data-ez-field-type-identifier"))a=e.all("#"+r.getAttribute("id")),s=!0;else var u=parseInt(r.getAttribute("data-ez-editable-region-level"),10)+1,a=e.all("#"+r.getAttribute("id")+" "+'[data-ez-editable-region-level="'+u+'"]');a.isEmpty()?o.appendChild(e.Node.create('<div style="text-align:center"><strong>No regions to edit!</strong></div>')):a.each(function(t,r){if(!t.hasAttribute("data-ez-editable-region-marker")){var s=e.one("#"+t.getAttribute("data-ez-editable-region-parent")).getAttribute("data-ez-editable-region-marker"),u=s+"."+(r+1);t.setAttribute("data-ez-editable-region-marker",u)}var a=e.all("#"+t.getAttribute("id")+" "+"[data-ez-field-type-identifier]"),f=o.appendChild(e.Node.create('<div class="ez-ei-from-editor-dialog-content-group"></div>')),l=e.Node.create(['<div class="',n,'" rel="',t.getAttribute("id"),'">',t.getAttribute("data-ez-editable-region-marker"),"</div>"].join(""));l.addClass("ez-ei-overlay-marker-blocks"),f.appendChild(l),a.isEmpty()?f.appendChild(i._processLeafNode2ContentModule(t,!0,l)):a.each(function(e){f.appendChild(i._processLeafNode2ContentModule(e,!1,null))})});var f=e.all(".ez-ei-expandable-widget");f.each(function(t){new e.eZ.Expandable({srcNode:"#"+t.generateID()})});var l=o.all("textarea");l.each(function(e){tinyMCE.execCommand("mceAddControl",!0,e.getAttribute("id"))}),s&&e.one(".ez-ei-form-editor-marker").setStyles({cursor:"default"})},_processLeafNode2ContentModule:function(t,n,r){var i=e.Node.create('<div class="ez-ei-from-editor-dialog-content-module"></div>');i.setAttribute("data-ez-ei-form-editor-module-target",t.getAttribute("id")),t.getAttribute("data-ez-field-type-identifier")=="ezstring"&&(i.append(a({label:t.getAttribute("data-ez-field-identifier"),value:e.Lang.trim(t.getHTML())})),n&&(r.removeClass("ez-ei-overlay-marker-blocks"),r.addClass("ez-ei-overlay-marker-text")));if(t.getAttribute("data-ez-field-type-identifier")=="ezimage"){var s=t.getAttribute("src");i.append(f({label:t.getAttribute("data-ez-field-identifier"),imageSource:s,selectFileName:s.replace(/^.*[\\\/]/,""),selectFileIcon:"&#x003b;"})),n&&(r.removeClass("ez-ei-overlay-marker-blocks"),r.addClass("ez-ei-overlay-marker-image"))}t.getAttribute("data-ez-field-type-identifier")=="eztext"&&(i.append(l({label:t.getAttribute("data-ez-field-identifier"),value:e.Lang.trim(t.getHTML())})),n&&(r.removeClass("ez-ei-overlay-marker-blocks"),r.addClass("ez-ei-overlay-marker-text")),i.one("textarea").generateID());if(t.getAttribute("data-ez-field-type-identifier")=="ezselection"||t.getAttribute("data-ez-field-type-identifier")=="ezobjectrelationlist")i.append(c({label:t.getAttribute("data-ez-field-identifier"),value:'Sorry, no interface for "Object relation list" and "Selection" field types yet.'})),n&&(r.removeClass("ez-ei-overlay-marker-blocks"),r.addClass("ez-ei-overlay-marker-list"));t.hasAttribute("data-ez-editable-region-disabled")&&(i.all("input").setAttribute("disabled","disabled"),i.all("input").removeClass("ez-ei-form-editor-focusable"),i.all("label").addClass("disabled"));if(t.hasAttribute("data-ez-editable-region-expandable-attributes")){var o=JSON.parse(t.getAttribute("data-ez-editable-region-expandable-attributes"));for(var u in o){var h=e.Node.create(['<div class="ez-ei-expandable-widget"><div class="ez-ei-expandable-header">',u,'</div><div class="ez-ei-expandable-content">',o[u],"</div></div>"].join(""));i.one(".content-input").appendChild(h)}}return i},_setFocus:function(){var e=o.one(".ez-ei-form-editor-focusable");e&&(e.focus(),e.hasClass("textarea")&&tinyMCE.execCommand("mceFocus",!1,e.getAttribute("id")))},_showFormEditorNodes:function(){var t=this._getFormEditorTarget();if(t){var n=e.all("."+p.CSS_PREFIX);n.show()}},_hideFormEditorNodes:function(){var t=this._getFormEditorTarget();if(t){var n=e.all("."+p.CSS_PREFIX);n.hide()}},_breadcrumbsLinkClickCallback:function(t){e.fire("formEditor:overlayClicked",{},t)},_breadcrumbsCloseClickCallback:function(){e.fire("formEditor:close")},_markerClick:function(t){t.preventDefault(),e.fire("formEditor:overlayClicked",{},e.one("#"+this.getAttribute("rel")))},_publishLinkClick:function(t){t.preventDefault();var n=o.get("children");n.each(function(t){var n=e.one("#"+t.generateID()+" .ez-ei-from-editor-dialog-content-module"),r=e.one("#"+n.getAttribute("data-ez-ei-form-editor-module-target")),i=e.one("#"+t.generateID()+" .content-input");i.hasClass("ezstring")&&r.setHTML(e.one("#"+i.generateID()+' input[type="text"]').get("value"));if(i.hasClass("eztext")){var s=e.one("#"+i.generateID()+" textarea");r.setHTML(tinyMCE.get(s.generateID()).getContent())}i.hasClass("ezimage")}),e.log("Content saved!"),e.fire("formEditor:close")},_closeLinkClick:function(t){t.preventDefault(),e.fire("formEditor:close")},_topNavigationReturnClick:function(t){t.preventDefault(),e.fire("formEditor:topNavigationReturn",{},e.one("#"+s.getAttribute("data-ez-form-editor-target-id")))},_imageFileSelectClick:function(e){alert("Select picture")}}),e.eZ.FormEditor=p},"0.2alpha",["widget"]);