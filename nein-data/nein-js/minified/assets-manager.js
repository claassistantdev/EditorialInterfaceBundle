//TODO: centralize dialog buttons
//TODO: file name while uploading
//TODO: continous progress bar mode
YUI.add("ez-assets-manager",function(e){"use strict";function n(e){n.superclass.constructor.apply(this,arguments)}e.namespace("eZ");var t=e.Lang;n.NAME="structure-inspector",n.CSS_PREFIX="ez-ei-"+n.NAME,n.ATTRS={},n.HTML_PARSER={},e.extend(n,e.Widget,{initializer:function(){this.sourceNode=this.get("srcNode"),this.uploaderNode=e.one("#ez-ei-media-uploader"),this.dropAreaNode=e.one(".ez-ei-media-drop-area"),this.progressIndicatorNode=e.one(".ez-ei-media-progress-indicator"),this.filesListNode=e.one(".ez-ei-media-area-files-list"),this.dialogNode=e.one(".ez-ei-media-upload-dialog"),this.sidePanelContent=e.one("#ez-ei-side-panel-right .ez-ei-side-panel-content"),this.fileInputNode=e.one("#ez-ei-media-drop-file-browse"),this.iFrameNode=e.one("#ez-ei-media-uploader-iframe"),this.progressNumFilesLeft=e.one(".ez-ei-media-progress-num-files-left"),this.progressNumFilesDone=e.one(".ez-ei-media-progress-num-files-done"),this.dialogNode.hide(),this.progressIndicatorNode.hide(),this.filesList=[],this.rejectedFilesList=[],this.allowedFileTypeArray=["image/png","image/jpeg","image/gif","image/tiff","video/flv","video/mpg","video/x-msvideo","application/pdf","application/doc"],this.allowedFileMaxSize=3e7,this._progressBar=new e.eZ.ProgressBar({srcNode:".ez-ei-media-progress-indicator"}),this.progressBarNode=e.one(".ez-ei-media-progress-bar-background"),this._viewTypeSelector=new e.eZ.Dropdown({srcNode:"#ez-ei-media-view-type-selector"}),!window.FileReader||(this.dropAreaNode.on("dragover",this._dropAreaDragOver,this),this.dropAreaNode.on("dragenter",this._dropAreaDragEnter,this),this.dropAreaNode.on("dragleave",this._dropAreaDragLeave,this),this.dropAreaNode.on("drop",this._dropAreaDrop,this)),this.dropAreaNode.delegate("click",this._dropAreaClick,"div"),this.fileInputNode.on("change",this._fileSelected,this),this.iFrameNode.on("load",this._iFrameFileLoaded,this),this.filesListNode.delegate("click",this._fileListDeleteClick,"li a",this),this.dialogNode.delegate("click",this._uploadButtonClick,".ez-ei-media-upload-dialog-button-upload",this),this.dialogNode.delegate("click",this._closeUploadDialog,".ez-ei-media-upload-dialog-button-cancel",this),this._syncNodes()},destructor:function(){},renderUI:function(){},bindUI:function(){},syncUI:function(){},update:function(){this._syncNodes()},_syncNodes:function(){this.filesListNode.empty();var t=this;if(this.filesList.length||this.rejectedFilesList.length)e.Array.forEach(this.filesList,function(e,n){t.filesListNode.prepend(['<li data-file-index="',n,'">',e.name," ",t._getReadableFileSizeString(e.size),'<a href="#delete" ></a>',"</li>"].join(""))}),this.rejectedFilesList.length&&(t.filesListNode.append('<li class="rejected-header">---------  can not be uploaded  ---------</li>'),e.Array.forEach(this.rejectedFilesList,function(e){t.filesListNode.append(['<li class="rejected">',e.name," ",t._getReadableFileSizeString(e.size),"<a></a>","</li>"].join(""))}));this.sidePanelContent.setStyle("bottom",parseInt(this.uploaderNode.getComputedStyle("height"),10)+40)},_addFileToList:function(t){this._fileNameIsUnique(t.name)?this.allowedFileTypeArray.indexOf(t.type)!=-1?t.size<this.allowedFileMaxSize?this.filesList.push(t):(e.log("ignoring by size "+t.name),this._rejectedFileNameIsUnique(t.name)&&this.rejectedFilesList.push(t)):(e.log("ignoring by type "+t.type),this._rejectedFileNameIsUnique(t.name)&&this.rejectedFilesList.push(t)):e.log("ignoring duplicate file "+t.name)},_removeFileFromList:function(t,n){var r=e.one('.ez-ei-media-area-files-list li[data-file-index="'+t+'"]'),i=this;r.transition({opacity:{duration:.5,value:0}},function(){i.filesList.splice(t,1),i._syncNodes(),n&&n()})},_removeRemainingItemsFromList:function(t){var n=e.all(".ez-ei-media-area-files-list li"),r=this;n.transition({opacity:{duration:.5,value:0}},function(){r.filesList=[],r.rejectedFilesList=[],r._syncNodes(),t&&t()})},_fileNameIsUnique:function(e){for(var t=0;t<this.filesList.length;t++)if(this.filesList[t].name===e)return!1;return!0},_rejectedFileNameIsUnique:function(e){for(var t=0;t<this.rejectedFilesList.length;t++)if(this.rejectedFilesList[t].name===e)return!1;return!0},_openUploadDialog:function(t){var n=this;this.dialogNode.show(),this.uploaderNode.addClass("uploading"),e.Array.forEach(t,function(e){n._addFileToList(e)}),this._syncNodes()},_closeUploadDialog:function(e){e&&e.preventDefault();var t=this;this._removeRemainingItemsFromList(function(){t.uploaderNode.removeClass("uploading")}),this.dialogNode.hide(),this.progressIndicatorNode.hide(),this.dropAreaNode.show()},_uploadStart:function(){this.dropAreaNode.hide(),this.dialogNode.hide(),this.progressNumFilesDone.setHTML("0"),this.progressNumFilesLeft.setHTML(this.filesList.length),this.progressIndicatorNode.show()},_uploadFinish:function(){var e=this;this.progressBarNode.hide(),this.rejectedFilesList.length&&this._removeRemainingItemsFromList(null),this.uploaderNode.transition({opacity:{duration:2,value:1}},function(){e.uploaderNode.removeClass("uploading"),e.progressIndicatorNode.hide(),e.progressBarNode.show(),e.dropAreaNode.show()})},_uploadSingleFile:function(e){var t=new XMLHttpRequest,n=this;t.open("post","/nein-data/upload.php",!0),t.setRequestHeader("X_FILENAME",e.name),t.setRequestHeader("X-FILESIZE",e.size),t.setRequestHeader("X-FILETYPE",e.type),t.upload.addEventListener("progress",this._uploadProgress.bind(this)),t.upload.addEventListener("load",this._uploadComplete.bind(this)),t.send(e)},_uploadNextFileFromList:function(){var e=this.filesList[this.filesList.length-1];e?this._uploadSingleFile(e):this._uploadFinish()},_uploadOldStyleStart:function(){this.uploaderNode.addClass("uploading"),this.dropAreaNode.hide(),this._progressBar.startSimpleProgress(),this.progressNumFilesDone.setHTML("0"),this.progressNumFilesLeft.setHTML("1"),this.progressIndicatorNode.show();var e=document.getElementById("ez-ei-media-uploader-fake-form"),t=document.getElementById("ez-ei-media-drop-file-browse"),n=t.cloneNode(!0);e.innerHTML="",e.appendChild(n),e.submit()},_uploadOldStyleFinish:function(){var e=this;this._progressBar.stopSimpleProgress(),this.progressBarNode.hide(),this.uploaderNode.transition({opacity:{duration:2,value:1}},function(){e.uploaderNode.removeClass("uploading"),e.progressIndicatorNode.hide(),e.progressBarNode.show(),e.dropAreaNode.show()})},_getReadableFileSizeString:function(e){var t=-1,n=[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"];do e/=1024,t++;while(e>1024);return Math.max(e,.1).toFixed(1)+n[t]},_dropAreaDragOver:function(e){e.preventDefault()},_dropAreaDragEnter:function(e){e.preventDefault(),this.uploaderNode.addClass("drag-over")},_dropAreaDragLeave:function(t){e.log(t),t.preventDefault(),t.relatedTarget!=this.dropAreaNode&&this.uploaderNode.removeClass("drag-over")},_dropAreaDrop:function(e){e.preventDefault(),this.uploaderNode.removeClass("drag-over"),this._openUploadDialog(e._event.dataTransfer.files)},_dropAreaClick:function(e){e.preventDefault(),document.getElementById("ez-ei-media-drop-file-browse").click(e._event)},_fileListDeleteClick:function(e){e.preventDefault(),this._removeFileFromList(e.currentTarget.get("parentNode").getAttribute("data-file-index"),null)},_uploadButtonClick:function(e){e.preventDefault(),this._uploadStart(),this._uploadNextFileFromList()},_uploadProgress:function(t){if(t.lengthComputable){var n=t.loaded/t.total*100;e.log(n),this._progressBar.update(n)}},_uploadComplete:function(e){this._progressBar.update(100);var t=parseInt(this.progressNumFilesDone.getHTML(),10),n=parseInt(this.progressNumFilesLeft.getHTML(),10);t++,n--,this.progressNumFilesDone.setHTML(t),this.progressNumFilesLeft.setHTML(n),this._removeFileFromList(this.filesList.length-1,this._uploadNextFileFromList.bind(this))},_fileSelected:function(e){e.preventDefault(),e.currentTarget._node.files?window.FileReader?this._openUploadDialog(e.currentTarget._node.files):alert("Your browser is not supporting fileAPI, which is not even possible! :)"):this._uploadOldStyleStart()},_iFrameFileLoaded:function(t){var n=document.getElementById("ez-ei-media-uploader-iframe").contentWindow.document.body.innerHTML;if(n){var r=e.JSON.parse(n);r.success?this._uploadOldStyleFinish():(this._uploadOldStyleFinish(),alert("upload failed for some reason :("))}}}),e.eZ.AssetsManager=n},"0.1alpha",["widget","node"]);